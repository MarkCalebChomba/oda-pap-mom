<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Listing</title>
    <link rel="stylesheet" href="listing.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<header>
    <div class="top-bar">
        <div class="logo-container">
            <img src="images/logo.jpg" alt="Oda Pap Logo" class="logo">
            <span class="logo-text">Oda Pap</span>
        </div>
        <div class="top-icons"></div>
            <button class="home-button" onclick="location.href='index.html'">Home</button>
        </div>

        

        <div class="top-icons">
           
           
            <div class="menu-icon" onclick="toggleMenu()">
                <i class="fas fa-bars"></i>
                <p>Menu</p>
            </div>
            <div class="dropdown-content" id="dropdown">
                <a href="student-centre.html" class="category">
                    <i class="fas fa-graduation-cap"></i>
                    <p>Student Centre</p>
                </a>
                <a href="electronics.html" class="category">
                    <i class="fas fa-tv"></i>
                    <p>Electronics</p>
                </a>
                <a href="kitchenware.html" class="category">
                    <i class="fas fa-blender"></i>
                    <p>Kitchenware</p>
                </a>
                <a href="furniture.html" class="category">
                    <i class="fas fa-couch"></i>
                    <p>Furniture</p>
                </a>
                <a href="fashion.html" class="category">
                    <i class="fas fa-tshirt"></i>
                    <p>Fashion</p>
                </a>
                <a href="beauty.html" class="category">
                    <i class="fas fa-heart"></i>
                    <p>Beauty</p>
                </a>
                <a href="rentals.html" class="category">
                    <i class="fas fa-building"></i>
                    <p>Rentals</p>
                </a>
                <a href="service-men.html" class="category">
                    <i class="fas fa-tools"></i>
                    <p>Service Men</p>
                </a>
                <a href="foodstuffs.html" class="category">
                    <i class="fas fa-carrot"></i>
                    <p>Foodstuffs</p>
                </a>
                <a href="phones.html" class="category">
                    <i class="fas fa-mobile-alt"></i>
                    <p>Phones</p>
                </a>
                <a href="accessories.html" class="category">
                    <i class="fas fa-headphones"></i>
                    <p>Accessories</p>
                </a>
                <a href="pharmaceutical.html" class="category">
                    <i class="fas fa-pills"></i>
                    <p>Pharmaceutical</p>
                </a>
                <a href="kids.html" class="category">
                    <i class="fas fa-hat-wizard"></i>
                    <p>kids</p>
                </a>
            </div>
            
           
            
                <script>
                    function toggleMenu() {
                        var dropdown = document.getElementById('dropdown');
                        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                    }
            
                    // Close the dropdown if clicked outside
                    window.onclick = function(event) {
                        if (!event.target.matches('.menu-icon') && !event.target.matches('.menu-icon *')) {
                            var dropdown = document.getElementById('dropdown');
                            if (dropdown.style.display === 'block') {
                                dropdown.style.display = 'none';
                            }
                        }
                    }
                </script>
            </div>
        </div>
        </div>
    </div>
    <div class="border-line"></div>
    <div class="nav-bar" id="nav-bar">
        <button class="home-button" onclick="location.href='index.html'"><i class="fas fa-home"></i></button>
        
        <button class="home-button" onclick="location.href='notification.html'"> <i class="fas fa-bell" id="notification-icon"></i></button>
        <button class="home-button" onclick="location.href='cart.html'"><i class="fas fa-shopping-cart" id="cart-icon"></i></button>
        <button class="home-button" onclick="location.href='profile.html'"><i class="fas fa-user-circle"></i></button>
       <!-- -->
        
    </div>
</header>
<body>
    <h1>Manage Your Listings</h1>
    
    <div id="profile-incomplete-message" style="display: none;">
        <p>Your profile is incomplete. Please update your profile before listing an item.</p>
    </div>

    <!-- User Profile Information -->
    <div id="profile-info">
        <img id="profile-pic" src="" alt="Profile Picture" width="100" />
        <p id="seller-name">Name: Unknown</p>
        <p id="seller-email">Email: Unknown</p>
        <p id="seller-location">Location: Location Unknown</p>
        <p id="user-ward">Location: Location Unknown</p>

    </div>

    <!-- Form to add/edit an item -->
    <form id="item-listing-form">
        <label for="item-name">Item Name:</label>
        <input type="text" id="item-name" required>
        <div class="form-group">
            <label for="item-price">Price (KES)</label>
            <input type="number" id="item-price" name="item-price" required>
            <p id="price-adjustment">Final price will include a small adjustment fee.</p>
        </div>

        <div class="form-group">
            <label for="quantity">Quantity</label>
            <input type="number" id="quantity" name="quantity" required min="1">
        </div>

        <div class="form-group">
            <label for="category">Category</label>
            <select id="category" name="category" required>
                <option value="">Select a category</option>
                <option value="fashion">Fashion - Trendy clothes and accessories</option>
                <option value="electronics">Electronics - Gadgets and devices</option>
                <option value="phones">Phones - Mobile phones and accessories</option>
                <option value="beauty">Beauty - Personal care products</option>
            </select>
        </div>


        <label for="item-price">Initial Price (KES):</label>
        <input type="number" id="initial-price" required>

        <!-- Condition dropdown -->
        <label for="condition">Condition:</label>
        <select id="condition" required>
            <option value="brand new">Brand New</option>
            <option value="pretty new">Pretty New</option>
            <option value="refurbished">Refurbished</option>
            <option value="second hand">Second Hand</option>
            <option value="old">Old</option>
            <option value="working">Working</option>
            <option value="not working">Not Working</option>
        </select>

        <!-- Age dropdown -->
        <label for="age">Age:</label>
        <select id="age" required>
            <option value="unused">Unused</option>
            <option value="fairly used">Fairly Used</option>
            <option value="used">Used</option>
            <option value="0-3 months">0-3 Months</option>
            <option value="4-6 months">4-6 Months</option>
            <option value="under 1 year">Under 1 Year</option>
            <option value="under 2 years">Under 2 Years</option>
            <option value="under 5 years">Under 5 Years</option>
            <option value="artefact">Artefact</option>
        </select>

        <!-- Description textarea -->
        <label for="description">Description:</label>
        <textarea id="description" rows="4" required></textarea>

        <div class="form-group">
            <label for="media-upload">Upload Media (Max 5)</label>
            <input type="file" id="media-upload" name="media-upload" accept="image/* , video/*" multiple required>
            <small>You can upload up to 5 images .</small>
        </div>

        

        <button type="submit" id="submit-button">List Item</button>
    </form>

    <!-- User listings -->
    <div id="listings-container"></div>

    <script type="module">
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";
        import { app } from "./js/firebase.js";

        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Check if profile is complete and user is authenticated
        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const userDoc = await getDoc(doc(db, "Users", user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        document.getElementById("profile-pic").src = userData.profilePicUrl || "Unknown";
                        document.getElementById("seller-name").textContent = userData.name || "Unknown";
                        document.getElementById("seller-email").textContent = userData.email || "Unknown";
                        document.getElementById("user-county").textContent = userData.county || "Location Unknown";
                        document.getElementById("user-ward").textContent = userData.ward || "Location Unknown";
                    } else {
                        document.getElementById("profile-incomplete-message").style.display = 'block';
                    }
                } else {
                    window.location.href = 'login.html'; // Redirect if no user is logged in
                }
            });
        });

        // Function to display listings for the authenticated user
        async function loadUserListings() {
            const user = auth.currentUser;
            const listingsContainer = document.getElementById('listings-container');
            listingsContainer.innerHTML = ''; // Clear existing listings

            if (user) {
                const q = query(collection(db, "Listings"), where("uploaderId", "==", user.uid));
                const querySnapshot = await getDocs(q);

                querySnapshot.forEach((doc) => {
                    const listing = doc.data();
                    const listingElement = document.createElement('div');
                    listingElement.className = 'listing';
                    listingElement.innerHTML = `
                        <div class="listing-media">
                            ${listing.imageUrls ? listing.imageUrls.map(url => `<img src="${url}" class="listing-img" />`).join('') : ''}
                        </div>
                        <h4>${listing.name}</h4>
                        <p><strong>Price:</strong> KES ${listing.price}</p>
                        <p><strong>Category:</strong> ${listing.category}</p>
                        <p><strong>Description:</strong> ${listing.description}</p>
                        <button class="edit-btn" data-id="${doc.id}">Edit</button>
                        <button class="delete-btn" data-id="${doc.id}">Delete</button>
                    `;

                    listingsContainer.appendChild(listingElement);
                });

                // Add event listeners for edit and delete buttons
                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', () => loadEditForm(button.dataset.id));
                });

                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', () => deleteListing(button.dataset.id));
                });
            }
        }

        // Load and populate the edit form with the current listing details
        async function loadEditForm(listingId) {
            const docRef = doc(db, "Listings", listingId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const listing = docSnap.data();
                document.getElementById('item-name').value = listing.name;
                document.getElementById('item-price').value = listing.price;
                document.getElementById('condition').value = listing.condition;
                document.getElementById('age').value = listing.age;
                document.getElementById('description').value = listing.description.replace(`${listing.condition}, ${listing.age} - `, "");

                // Change the submit button to 'Update' and store listing ID
                document.getElementById('submit-button').innerText = 'Update Item';
                document.getElementById('submit-button').dataset.id = listingId;
            } else {
                alert("Listing not found!");
            }
        }

        // Handle form submission (for both adding new items and updating existing items)
        document.getElementById('item-listing-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            const user = auth.currentUser;
            if (!user) {
                alert("You need to be logged in to list an item.");
                return;
            }

            const itemName = document.getElementById('item-name').value;
            const itemPrice = document.getElementById('item-price').value;
            const condition = document.getElementById('condition').value;
            const age = document.getElementById('age').value;
            const description = document.getElementById('description').value;
            const mediaFiles = document.getElementById('media-upload').files;

            // Concatenate the condition, age, and user-written description into a single description
            const fullDescription = `${condition}, ${age} - ${description}`;

            let imageUrls = [];
            for (let i = 0; i < mediaFiles.length; i++) {
                const file = mediaFiles[i];
                const storageRefPath = storageRef(storage, `listings/${user.uid}/${file.name}`);
                const snapshot = await uploadBytes(storageRefPath, file);
                const imageUrl = await getDownloadURL(snapshot.ref);
                imageUrls.push(imageUrl);
            }

            let finalPrice = parseFloat(itemPrice);
            if (finalPrice < 10000) {
                finalPrice += finalPrice * 0.05;
            } else {
                finalPrice += finalPrice * 0.025;
            }

            const listingId = document.getElementById('submit-button').dataset.id;

            if (listingId) {
                // Update existing listing
                const docRef = doc(db, "Listings", listingId);
                await updateDoc(docRef, {
                    name: itemName,
                    price: finalPrice,
                    condition: condition,
                    age: age,
                    description: fullDescription,
                    imageUrls: imageUrls.length ? imageUrls : undefined // Update only if media exists
                });
                alert("Item updated successfully!");
            } else {
                // Add new listing
                await addDoc(collection(db, "Listings"), {
                    uploaderId: user.uid,
                    name: itemName,
                    price: finalPrice,
                    condition: condition,
                    age: age,
                    description: fullDescription,
                    imageUrls: imageUrls,
                    createdAt: new Date().toISOString()
                });
                alert("Item listed successfully!");
            }

            event.target.reset();
            document.getElementById('submit-button').innerText = 'List Item';
            loadUserListings(); // Reload listings after update
        });

        // Function to delete a listing
        async function deleteListing(listingId) {
            if (confirm("Are you sure you want to delete this item?")) {
                await deleteDoc(doc(db, "Listings", listingId));
                alert("Item deleted successfully!");
                loadUserListings(); // Reload listings after delete
            }
        }

        // Ensure user authentication and load listings on page load
        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    await loadUserListings(); // Load the user's listings
                } else {
                    window.location.href = 'login.html'; // Redirect to login if not authenticated
                }
            });
        });
    </script>
</body>
</html>
